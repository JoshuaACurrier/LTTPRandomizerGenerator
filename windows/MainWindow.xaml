<Window x:Class="LTTPRandomizerGenerator.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:LTTPRandomizerGenerator.Controls"
        Title="LTTP Randomizer Generator"
        Width="680" Height="820"
        MinWidth="600" MinHeight="700"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource BgBrush}"
        Foreground="{StaticResource TextBrush}"
        FontFamily="Segoe UI" FontSize="13"
        Icon="Resources/icon.ico">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    </Window.Resources>

    <Grid Margin="20" Background="{StaticResource BgBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- header -->
            <RowDefinition Height="Auto"/>  <!-- file pickers -->
            <RowDefinition Height="Auto"/>  <!-- separator -->
            <RowDefinition Height="Auto"/>  <!-- preset row -->
            <RowDefinition Height="*"/>     <!-- settings -->
            <RowDefinition Height="Auto"/>  <!-- generate button -->
            <RowDefinition Height="Auto"/>  <!-- progress + status -->
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,16">
            <TextBlock Text="LTTP Randomizer Generator"
                       FontSize="22" FontWeight="Bold"
                       Foreground="{StaticResource AccentBrush}"/>
            <TextBlock Text="Generate a randomized A Link to the Past ROM via alttpr.com"
                       Foreground="{StaticResource TextMutedBrush}" Margin="0,2,0,0"/>
        </StackPanel>

        <!-- File pickers -->
        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="8"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="6"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="110"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Row="0" Grid.Column="0" Text="Base ROM:"
                       Foreground="{StaticResource TextBrush}" VerticalAlignment="Center"/>
            <TextBox   Grid.Row="0" Grid.Column="1" x:Name="RomPathBox" IsReadOnly="True"
                       Style="{StaticResource DarkTextBox}"
                       Text="{Binding RomPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                       VerticalAlignment="Center"/>
            <Button    Grid.Row="0" Grid.Column="2" Content="Browse..." Margin="6,0,0,0"
                       Style="{StaticResource DarkButton}"
                       Click="BrowseRom_Click"/>

            <TextBlock Grid.Row="2" Grid.Column="0" Text="Output Folder:"
                       Foreground="{StaticResource TextBrush}" VerticalAlignment="Center"/>
            <TextBox   Grid.Row="2" Grid.Column="1" IsReadOnly="True"
                       Style="{StaticResource DarkTextBox}"
                       Text="{Binding OutputFolder, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                       VerticalAlignment="Center"/>
            <Button    Grid.Row="2" Grid.Column="2" Content="Browse..." Margin="6,0,0,0"
                       Style="{StaticResource DarkButton}"
                       Click="BrowseOutput_Click"/>

            <CheckBox  Grid.Row="4" Grid.Column="1"
                       Content="ES-DE Mode (output to lttpr\ subfolder with gamelist.xml)"
                       IsChecked="{Binding IsEsDeMode, Mode=TwoWay}"
                       Foreground="{StaticResource TextMutedBrush}"
                       FontSize="11"/>
        </Grid>

        <Separator Grid.Row="2" Margin="0,10"/>

        <!-- Preset row -->
        <Grid Grid.Row="3" Margin="0,0,0,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="110"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Column="0" Text="Preset:"
                       Foreground="{StaticResource TextBrush}" VerticalAlignment="Center"/>
            <Grid Grid.Column="1">
                <ComboBox x:Name="PresetCombo"
                          Style="{StaticResource DarkComboBox}"
                          ItemsSource="{Binding AllPresets}"
                          SelectedItem="{Binding SelectedPreset, Mode=TwoWay}"
                          DisplayMemberPath="Name"
                          SelectionChanged="PresetCombo_SelectionChanged"/>
                <TextBlock Text="Unsaved" IsHitTestVisible="False"
                           VerticalAlignment="Center" Margin="6,0"
                           FontStyle="Italic"
                           Foreground="{StaticResource TextMutedBrush}"
                           Visibility="{Binding IsPresetUnsaved, Converter={StaticResource BoolToVis}}"/>
            </Grid>

            <TextBox   Grid.Column="2" x:Name="PresetNameBox" Width="140" Margin="6,0,0,0"
                       Style="{StaticResource DarkTextBox}"
                       Text="{Binding NewPresetName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                       VerticalAlignment="Center"/>

            <Button    Grid.Column="3" Content="Save" Margin="4,0,0,0"
                       Style="{StaticResource DarkButton}"
                       Click="SavePreset_Click"/>
            <Button    Grid.Column="4" Content="Delete" Margin="4,0,0,0"
                       Style="{StaticResource DangerOutlineButton}"
                       IsEnabled="{Binding CanDeletePreset}"
                       Click="DeletePreset_Click"/>
        </Grid>

        <!-- Settings panel (Customization + Randomizer Settings) -->
        <ScrollViewer Grid.Row="4" VerticalScrollBarVisibility="Auto">
            <StackPanel>

                <!-- Sprite selection (always visible) -->
                <Grid Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Preview area: sprite image or random placeholder -->
                    <Grid Grid.Column="0" Grid.RowSpan="2"
                          Margin="0,0,10,0" VerticalAlignment="Center">

                        <!-- Normal sprite preview (hidden when random) -->
                        <controls:SpriteImageControl ImageUrl="{Binding EffectiveSpritePreviewUrl}">
                            <controls:SpriteImageControl.Style>
                                <Style TargetType="controls:SpriteImageControl">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsRandomSprite}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </controls:SpriteImageControl.Style>
                        </controls:SpriteImageControl>

                        <!-- Random placeholder (shown when random is selected) -->
                        <Border Width="64" Height="64" CornerRadius="4" Background="#2A2A3A">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsRandomSprite}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <TextBlock Text="{Binding RandomGlyph}"
                                       HorizontalAlignment="Center" VerticalAlignment="Center"
                                       FontSize="28" FontWeight="Bold" Foreground="#DAA520"/>
                        </Border>

                    </Grid>

                    <!-- Sprite name -->
                    <TextBlock Grid.Column="1" Grid.Row="0"
                               Text="{Binding SpriteDisplayName}"
                               VerticalAlignment="Bottom"
                               Foreground="{StaticResource TextBrush}"
                               FontWeight="SemiBold"
                               TextTrimming="CharacterEllipsis"
                               Margin="0,0,6,4"/>

                    <!-- Buttons -->
                    <StackPanel Grid.Column="2" Grid.RowSpan="2"
                                Orientation="Vertical" VerticalAlignment="Center">
                        <Button Content="Browse..." Margin="0,0,0,4"
                                Style="{StaticResource DarkButton}"
                                Click="BrowseSprite_Click"/>
                        <Button Content="Clear"
                                Style="{StaticResource DarkButton}"
                                Click="ClearSprite_Click"/>
                    </StackPanel>
                </Grid>

                <Separator Margin="0,0,0,10" Background="{StaticResource BorderBrush}"/>

                <!-- Customization section -->
                <TextBlock Text="{Binding CustomizationToggleLabel}"
                           Foreground="{StaticResource TextMutedBrush}"
                           FontSize="11" FontWeight="SemiBold"
                           Cursor="Hand"
                           Margin="0,0,0,8"
                           MouseLeftButtonUp="ToggleCustomization_Click"/>

                <ItemsControl ItemsSource="{Binding CustomizationRows}"
                              Visibility="{Binding IsCustomizationExpanded, Converter={StaticResource BoolToVis}}"
                              Margin="0,0,0,10">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,3">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="200"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="{Binding Label}"
                                           VerticalAlignment="Center"
                                           Foreground="{StaticResource TextMutedBrush}"/>
                                <ComboBox  Grid.Column="1"
                                           Style="{StaticResource DarkComboBox}"
                                           ItemsSource="{Binding Options}"
                                           SelectedItem="{Binding SelectedOption, Mode=TwoWay}"
                                           DisplayMemberPath="Display"/>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Randomizer Settings section -->
                <TextBlock Text="{Binding SettingsToggleLabel}"
                           Foreground="{StaticResource TextMutedBrush}"
                           FontSize="11" FontWeight="SemiBold"
                           Cursor="Hand"
                           Margin="0,0,0,8"
                           MouseLeftButtonUp="ToggleSettings_Click"/>

                <ItemsControl ItemsSource="{Binding SettingRows}"
                              Visibility="{Binding IsSettingsExpanded, Converter={StaticResource BoolToVis}}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,3">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="200"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="{Binding Label}"
                                           VerticalAlignment="Center"
                                           Foreground="{StaticResource TextMutedBrush}"/>
                                <ComboBox  Grid.Column="1"
                                           Style="{StaticResource DarkComboBox}"
                                           ItemsSource="{Binding Options}"
                                           SelectedItem="{Binding SelectedOption, Mode=TwoWay}"
                                           DisplayMemberPath="Display"/>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

            </StackPanel>
        </ScrollViewer>

        <!-- Generate button -->
        <Button Grid.Row="5" Content="Generate ROM"
                Style="{StaticResource AccentButton}"
                IsEnabled="{Binding CanGenerate}"
                Margin="0,12,0,0"
                Click="Generate_Click"/>

        <!-- Progress + status -->
        <StackPanel Grid.Row="6" Margin="0,8,0,0">
            <ProgressBar Style="{StaticResource DarkProgressBar}"
                         IsIndeterminate="{Binding IsGenerating}"
                         Visibility="{Binding IsGenerating, Converter={StaticResource BoolToVis}}"/>
            <TextBlock Text="{Binding StatusMessage}"
                       Foreground="{Binding StatusColor}"
                       Margin="0,6,0,0" TextWrapping="Wrap"/>
            <TextBlock Text="{Binding SeedPermalink}"
                       Foreground="{StaticResource AccentBrush}"
                       TextDecorations="Underline" Cursor="Hand"
                       Visibility="{Binding HasSeedLink, Converter={StaticResource BoolToVis}}"
                       MouseLeftButtonUp="SeedLink_Click"
                       Margin="0,2,0,0"/>
        </StackPanel>
    </Grid>
</Window>
