# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

Dual-platform randomizer seed generator for *A Link to the Past*. Communicates with the alttpr.com API to fetch settings, downloads BPS patches, and applies them locally to produce a randomized `.sfc` ROM. The base ROM never leaves the device — only settings are sent to the API.

---

## Build Commands

### Windows

```bash
cd windows

# Development
dotnet build -c Debug

# Production single-file EXE
dotnet publish -c Release -r win-x64 --self-contained true \
  -p:PublishSingleFile=true -p:PublishTrimmed=false \
  -p:IncludeNativeLibrariesForSelfExtract=true \
  -p:DebugType=none -p:DebugSymbols=false
# Output: windows/bin/Release/net8.0-windows/win-x64/publish/LTTPRandomizerGenerator.exe
```

### Android

Build with Android Studio (open `android/` as the project root). No `gradlew` is checked into the repo; the Gradle wrapper must be generated by Android Studio on first open.

- **Min SDK**: 30 (Android 11) — **Target SDK**: 34
- Package: `com.lttprandomizer`

### Releases

Push a tag matching `v*.*.*` to trigger GitHub Actions workflows that build both platforms and attach artifacts to a release.

---

## Architecture

### Windows — `windows/`

**MVVM-lite**: `MainWindow.xaml.cs` is both view and ViewModel (`DataContext = this`). All services are static/stateless. No DI container.

**Error-handling idiom throughout**: static methods return `string?` — `null` = success, non-null = error message.

```csharp
// Every service follows this pattern
public static string? Apply(...)
{
    try { /* work */ return null; }
    catch (Exception ex) { return $"Error: {ex.Message}"; }
}
```

**Key computed property**: `CanGenerate` depends on `IsGenerating`, `RomPath`, and `OutputFolder`. Call `OnPropertyChanged(nameof(CanGenerate))` in any setter that affects it.

**Settings ↔ UI sync**: `BuildSettingRows()` creates `SettingRowModel` entries from `SettingsOptions` option lists. `CurrentSettings()` reads back from rows. `ApplySettingsToRows()` sets row indices. `TryMatchPreset()` serializes current settings to JSON and compares against all presets to auto-select a match.

**Sprite sentinels** in `CustomizationSettings.SpritePath`:
- `"__random_all__"` — pick any random sprite at generate time
- `"__random_favorites__"` — pick random from favorites
- Empty string — default Link

### Android — `android/`

Single-Activity (`MainActivity.kt`). No Fragments, no ViewModel, no Compose. State is plain Kotlin properties; UI is updated directly via view binding.

`SettingRowModel` is reused for both randomizer settings rows and customization rows. `suppressPresetApply` flag prevents feedback loops when setting spinners programmatically.

**Threading**: all blocking work runs in `lifecycleScope.launch { withContext(Dispatchers.IO) { ... } }`.

---

## Generation Pipeline (both platforms)

Applies in this exact order after receiving the API response:

1. **Validate ROM** — strip 512-byte copier header if present; check size = 1 MB
2. **POST `/api/randomizer`** with `RandomizerSettings` → `{ hash, patch, size }`
3. **GET `/api/h/{hash}`** → `bpsLocation` URL
4. **Download BPS patch** from `bpsLocation`
5. **Apply BPS patch** (`BpsPatcher`) — decompress, apply four action types, verify CRC32
6. **Expand ROM** to `size` MB (typically 2 MB) by zero-padding
7. **Apply dict patches** — `patch` array: each entry maps a hex offset to a byte list
8. **Recalculate SNES HiROM checksum** at `0x7FDC–0x7FDF`
9. **Apply cosmetic patches** (`CosmeticPatcher`) — writes to expansion area `0x18xxxx` (must come after BPS expansion)
10. **Apply sprite** (optional) — ZSPR/SPR pixel + palette data into ROM addresses
11. **Write output** as `lttp_rand_{hash}.sfc`

---

## Key Services (Windows — all static)

| Service | File | Responsibility |
|---------|------|----------------|
| `AlttprApiClient` | `Services/AlttprApiClient.cs` | API calls; returns `SeedResult { Hash, Permalink, BpsPatchBytes, DictionaryPatches, RomSizeMb }` |
| `BpsPatcher` | `Services/BpsPatcher.cs` | BPS decompression + dict patch application + checksum |
| `RomValidator` | `Services/RomValidator.cs` | Validate ROM path/size; strip copier header |
| `CosmeticPatcher` | `Services/CosmeticPatcher.cs` | Write cosmetic bytes to expansion area; recalc checksum |
| `SpriteApplier` | `Services/SpriteApplier.cs` | Write ZSPR/SPR pixel + palette data into ROM |
| `PresetManager` | `Services/PresetManager.cs` | Save/load presets + last settings to `%AppData%` |
| `CustomizationManager` | `Services/CustomizationManager.cs` | Save/load sprite path + cosmetics to `%AppData%` |
| `FavoritesManager` | `Services/FavoritesManager.cs` | Save/load sprite favorites (`HashSet<string>`) to `%LocalAppData%` |

---

## ROM Addresses

**Cosmetic patches** (expansion area, valid only after BPS expansion to 2 MB):

| Setting | Address | Values |
|---------|---------|--------|
| Heart beep | `0x180033` | `0x00` off · `0x10` double · `0x20` normal · `0x40` half · `0x80` quarter |
| Heart color | `0x187020` | `0x00` red · `0x01` blue · `0x02` green · `0x03` yellow |
| Menu speed | `0x180048` | `0x04` half · `0x08` normal · `0x10` double · `0x18` triple · `0x20` quad · `0xE8` instant |
| Quick swap | `0x18004B` | `0x00` off · `0x01` on |

**Sprite injection**:
- `0x80000` — pixel/gfx data (≤ 28,672 bytes)
- `0xDD308` — main palette (`palLength - 4` bytes)
- `0xDEDF5` — gloves palette (last 4 bytes)

**SNES HiROM checksum**: zero `0x7FDC–0x7FDF`, sum all bytes, write `complement = sum ^ 0xFFFF` at `0x7FDC–0x7FDD` and `checksum = sum & 0xFFFF` at `0x7FDE–0x7FDF` (little-endian).

---

## ZSPR Header Layout

```
Bytes  0– 3: magic "ZSPR"
Bytes  9–12: gfx data offset (uint32 LE)
Bytes 13–14: gfx data length (uint16 LE)
Bytes 15–18: palette data offset (uint32 LE)
Bytes 19–20: palette data length (uint16 LE)
```

Legacy `.spr` files are raw 28,672-byte gfx with no header (write only to `0x80000`).

---

## Data Persistence

### Windows (`%AppData%\LTTPRandomizerGenerator\`)
- `presets.json` — user-saved presets
- `last_settings.json` — last-used randomizer settings (auto-restored on launch)
- `paths.json` — ROM path + output folder
- `customization.json` — sprite path + cosmetics

### Windows (`%LocalAppData%\LTTPRandomizerGenerator\`)
- `sprites_list.json` — cached sprite list from alttpr.com/sprites
- `sprite_favorites.json` — `HashSet<string>` of favorite sprite names
- `SpriteCache\{name}.zspr` — downloaded sprite files
- `SpriteCache\Previews\` — cached preview images

### Android (SharedPreferences key `"lttp_randomizer_prefs"`)
- `user_presets` — serialized user presets
- `last_settings` — last-used randomizer settings
- `last_customization` — sprite path + cosmetics
- `sprite_favorites` — `Set<String>` of favorite sprite names

### Android (`context.cacheDir`)
- `sprites_list.json` — cached sprite list
- `zspr_cache/{name}.zspr` — downloaded sprite files

---

## Adding New Features

**New randomizer setting**: add field to `RandomizerSettings`, define options in `SettingsOptions`, add `SettingRowModel` in `BuildSettingRows()`, handle in `CurrentSettings()` and `ApplySettingsToRows()`.

**New cosmetic patch**: add ROM address constant in `CosmeticPatcher`, define byte-value mapping, add to `Apply()`.

**New built-in preset**: add to `BuiltInPresets.All` (Windows) / `BuiltInPresets.all` (Android) with `IsBuiltIn = true`.

---

## No Automated Tests

There are no unit tests or integration tests in either platform. Testing is manual.
